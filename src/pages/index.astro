---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Chatbot de Becas - Generalitat Valenciana">
	<main>
		<header class="header">
			<div class="header-content">
				<div class="logo">
					<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
						<rect width="40" height="40" rx="8" fill="#c41f3e"/>
						<path d="M12 14h16M12 20h16M12 26h10" stroke="white" stroke-width="2" stroke-linecap="round"/>
						<circle cx="28" cy="26" r="3" fill="white"/>
					</svg>
				</div>
				<div class="header-text">
					<h1>Asistente de Becas</h1>
					<p>Generalitat Valenciana</p>
				</div>
			</div>
			<div class="status-indicator">
				<span class="status-dot"></span>
				<span class="status-text">Conectado</span>
			</div>
		</header>

		<div class="chat-container">
			<div id="chat-messages" class="chat-messages">
				<div class="message-wrapper bot-wrapper">
					<div class="avatar bot-avatar">IA</div>
					<div class="message-bubble bot-bubble">
						<div class="message-header">
							<span class="sender-name">Asistente</span>
							<span class="message-time">Ahora</span>
						</div>
						<div class="message-text">
							Bienvenido al servicio de información sobre becas de la Generalitat Valenciana. Estoy aquí para ayudarle con consultas sobre requisitos, plazos y procesos de solicitud. ¿En qué puedo asistirle?
						</div>
					</div>
				</div>
			</div>

			<form id="chat-form" class="chat-input-form">
				<div class="input-wrapper">
					<input 
						type="text" 
						id="user-input" 
						class="chat-input" 
						placeholder="Escribe tu pregunta sobre becas..."
						autocomplete="off"
						required
					/>
					<button type="submit" class="send-button" id="send-button">
						<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
							<path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
						</svg>
					</button>
				</div>
			</form>
		</div>
	</main>
</Layout>

<style is:global>
	:root {
		--primary: #c41f3e;
		--primary-dark: #a01830;
		--text: #1a1a1a;
		--text-secondary: #6c757d;
	}

	* {
		margin: 0;
		padding: 0;
		box-sizing: border-box;
	}

	main {
		height: 100vh;
		display: flex;
		flex-direction: column;
		background: #ffffff;
		overflow: hidden;
	}

	/* HEADER */
	.header {
		background: #ffffff;
		border-bottom: 2px solid #f0f0f0;
		padding: 1rem 2rem;
		display: flex;
		justify-content: space-between;
		align-items: center;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
		z-index: 10;
	}

	.header-content {
		display: flex;
		align-items: center;
		gap: 1rem;
	}

	.logo {
		display: flex;
		align-items: center;
	}

	.header-text h1 {
		font-size: 1.5rem;
		font-weight: 700;
		color: var(--primary);
		margin: 0;
	}

	.header-text p {
		font-size: 0.8rem;
		color: var(--text-secondary);
		margin: 0.25rem 0 0 0;
	}

	.status-indicator {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.5rem 1rem;
		background: rgba(34, 197, 94, 0.1);
		border: 1px solid rgba(34, 197, 94, 0.3);
		border-radius: 2rem;
	}

	.status-dot {
		width: 8px;
		height: 8px;
		background: #22c55e;
		border-radius: 50%;
		box-shadow: 0 0 10px #22c55e;
	}

	.status-text {
		font-size: 0.85rem;
		color: #22c55e;
		font-weight: 500;
	}

	/* CHAT CONTAINER */
	.chat-container {
		flex: 1;
		display: flex;
		flex-direction: column;
		max-width: 900px;
		width: 100%;
		margin: 0 auto;
		padding: 2rem 1rem;
		overflow: hidden;
	}

	.chat-messages {
		flex: 1;
		overflow-y: auto;
		padding: 0 1rem;
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	/* MENSAJES */
	.message-wrapper {
		display: flex;
		gap: 0.75rem;
		align-items: flex-end;
		width: 100%;
	}

	.bot-wrapper {
		justify-content: flex-start;
	}

	.user-wrapper {
		flex-direction: row-reverse;
		justify-content: flex-start;
	}

	.avatar {
		width: 40px;
		height: 40px;
		min-width: 40px;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 0.85rem;
		font-weight: 600;
		color: #ffffff;
		flex-shrink: 0;
	}

	.bot-avatar {
		background: linear-gradient(135deg, var(--primary), var(--primary-dark));
		box-shadow: 0 2px 8px rgba(196, 31, 62, 0.25);
	}

	.user-avatar {
		background: linear-gradient(135deg, #495057, #343a40);
		box-shadow: 0 2px 8px rgba(52, 58, 64, 0.25);
	}

	.message-bubble {
		max-width: 70%;
		padding: 0.875rem 1.125rem;
		border-radius: 18px;
		word-wrap: break-word;
		overflow-wrap: break-word;
	}

	.bot-bubble {
		background: #f0f0f0 !important;
		border-radius: 18px 18px 18px 4px !important;
		box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
	}

	.user-bubble {
		background: var(--primary) !important;
		border-radius: 18px 18px 4px 18px !important;
		box-shadow: 0 1px 2px rgba(196, 31, 62, 0.3) !important;
	}

	.message-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 0.4rem;
		gap: 1rem;
	}

	.sender-name {
		font-size: 0.75rem;
		font-weight: 600;
		color: #6c757d;
	}

	.user-bubble .sender-name {
		color: rgba(255, 255, 255, 0.9);
	}

	.message-time {
		font-size: 0.7rem;
		color: #adb5bd;
	}

	.user-bubble .message-time {
		color: rgba(255, 255, 255, 0.75);
	}

	.message-text {
		color: #1a1a1a !important;
		line-height: 1.6 !important;
		font-size: 0.95rem !important;
		white-space: pre-wrap !important;
		word-wrap: break-word !important;
		overflow-wrap: break-word !important;
	}

	.message-text p {
		margin: 0.5rem 0;
	}

	.message-text p:first-child {
		margin-top: 0;
	}

	.message-text p:last-child {
		margin-bottom: 0;
	}

	.message-text strong {
		font-weight: 700;
		color: var(--primary);
	}

	.user-bubble .message-text {
		color: #ffffff !important;
	}

	.user-bubble .message-text strong {
		color: #ffffff;
		font-weight: 700;
	}

	/* TYPING INDICATOR */
	.typing-wrapper {
		display: flex;
		gap: 0.75rem;
		align-items: flex-end;
	}

	.typing-bubble {
		padding: 0.875rem 1.125rem;
		background: #f0f0f0;
		border-radius: 18px 18px 18px 4px;
		display: flex;
		gap: 0.5rem;
		box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
	}

	.typing-dot {
		width: 8px;
		height: 8px;
		background: #adb5bd;
		border-radius: 50%;
		animation: typing 1.4s infinite;
	}

	.typing-dot:nth-child(2) { animation-delay: 0.2s; }
	.typing-dot:nth-child(3) { animation-delay: 0.4s; }

	@keyframes typing {
		0%, 60%, 100% {
			transform: translateY(0);
			opacity: 0.5;
		}
		30% {
			transform: translateY(-6px);
			opacity: 1;
		}
	}

	/* INPUT FORM */
	.chat-input-form {
		margin-top: 1rem;
		padding: 0 1rem;
	}

	.input-wrapper {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		padding: 0.875rem 1.25rem;
		background: #ffffff;
		border: 2px solid #e9ecef;
		border-radius: 24px;
		box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
		transition: all 0.3s ease;
	}

	.input-wrapper:focus-within {
		border-color: var(--primary);
		box-shadow: 0 0 0 4px rgba(196, 31, 62, 0.1), 0 4px 16px rgba(0, 0, 0, 0.12);
	}

	.chat-input {
		flex: 1;
		border: none;
		outline: none;
		font-size: 1rem;
		padding: 0.25rem 0;
		background: transparent;
		color: var(--text);
		font-family: inherit;
		line-height: 1.5;
	}

	.chat-input::placeholder {
		color: #adb5bd;
	}

	.send-button {
		background: var(--primary);
		color: #ffffff;
		border: none;
		border-radius: 12px;
		width: 44px;
		height: 44px;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		transition: all 0.2s ease;
		flex-shrink: 0;
		box-shadow: 0 2px 8px rgba(196, 31, 62, 0.3);
	}

	.send-button:hover {
		background: var(--primary-dark);
		transform: scale(1.05);
		box-shadow: 0 4px 12px rgba(196, 31, 62, 0.4);
	}

	.send-button:active {
		transform: scale(0.98);
	}

	.send-button:disabled {
		background: #dee2e6;
		color: #adb5bd;
		cursor: not-allowed;
		transform: none;
		box-shadow: none;
	}

	/* SCROLLBAR */
	.chat-messages::-webkit-scrollbar {
		width: 6px;
	}

	.chat-messages::-webkit-scrollbar-track {
		background: transparent;
	}

	.chat-messages::-webkit-scrollbar-thumb {
		background: #dee2e6;
		border-radius: 10px;
	}

	.chat-messages::-webkit-scrollbar-thumb:hover {
		background: #adb5bd;
	}

	/* RESPONSIVE */
	@media (max-width: 768px) {
		.header {
			padding: 1rem 1.5rem;
		}

		.message-bubble {
			max-width: 85%;
		}

		.avatar {
			width: 35px;
			height: 35px;
			min-width: 35px;
			font-size: 0.75rem;
		}
	}
</style>

<script>
	const chatForm = document.getElementById('chat-form') as HTMLFormElement;
	const userInput = document.getElementById('user-input') as HTMLInputElement;
	const chatMessages = document.getElementById('chat-messages') as HTMLDivElement;
	const sendButton = document.getElementById('send-button') as HTMLButtonElement;

	function getCurrentTime() {
		const now = new Date();
		return now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
	}

	function addMessage(content: string, isUser: boolean) {
		const wrapper = document.createElement('div');
		wrapper.className = `message-wrapper ${isUser ? 'user-wrapper' : 'bot-wrapper'}`;
		
		const avatar = document.createElement('div');
		avatar.className = `avatar ${isUser ? 'user-avatar' : 'bot-avatar'}`;
		avatar.textContent = isUser ? 'U' : 'IA';
		
		const bubble = document.createElement('div');
		bubble.className = `message-bubble ${isUser ? 'user-bubble' : 'bot-bubble'}`;
		
		const header = document.createElement('div');
		header.className = 'message-header';
		
		const senderName = document.createElement('span');
		senderName.className = 'sender-name';
		senderName.textContent = isUser ? 'Usuario' : 'Asistente';
		
		const time = document.createElement('span');
		time.className = 'message-time';
		time.textContent = getCurrentTime();
		
		header.appendChild(senderName);
		header.appendChild(time);
		
		const text = document.createElement('div');
		text.className = 'message-text';
		
		// Formatear texto con párrafos y negritas
		const formattedContent = content
			.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Negritas
			.replace(/\n\n/g, '</p><p>') // Párrafos dobles
			.trim();
		
		// Si tiene párrafos, envolver en <p>
		if (formattedContent.includes('</p>')) {
			text.innerHTML = '<p>' + formattedContent + '</p>';
		} else {
			text.innerHTML = formattedContent;
		}
		
		bubble.appendChild(header);
		bubble.appendChild(text);
		
		wrapper.appendChild(avatar);
		wrapper.appendChild(bubble);
		
		chatMessages.appendChild(wrapper);
		chatMessages.scrollTop = chatMessages.scrollHeight;
	}

	function showTypingIndicator() {
		const wrapper = document.createElement('div');
		wrapper.className = 'message-wrapper bot-wrapper typing-wrapper';
		wrapper.id = 'typing-indicator';
		
		const avatar = document.createElement('div');
		avatar.className = 'avatar bot-avatar';
		avatar.textContent = 'IA';
		
		const bubble = document.createElement('div');
		bubble.className = 'typing-bubble';
		bubble.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
		
		wrapper.appendChild(avatar);
		wrapper.appendChild(bubble);
		
		chatMessages.appendChild(wrapper);
		chatMessages.scrollTop = chatMessages.scrollHeight;
	}

	function removeTypingIndicator() {
		const indicator = document.getElementById('typing-indicator');
		if (indicator) {
			indicator.remove();
		}
	}

	chatForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		
		const message = userInput.value.trim();
		if (!message) return;

		addMessage(message, true);
		userInput.value = '';
		sendButton.disabled = true;

		showTypingIndicator();

		try {
			const response = await fetch('/api/chat', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ message }),
			});

			if (!response.ok) {
				throw new Error('Error en la respuesta del servidor');
			}

			const data = await response.json();
			removeTypingIndicator();
			addMessage(data.response, false);
		} catch (error) {
			removeTypingIndicator();
			addMessage('Lo siento, ha ocurrido un error. Por favor, intenta de nuevo.', false);
		} finally {
			sendButton.disabled = false;
			userInput.focus();
		}
	});
</script>
